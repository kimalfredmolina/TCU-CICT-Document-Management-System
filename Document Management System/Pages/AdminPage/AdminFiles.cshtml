@page
@model Document_Management_System.Pages.AdminPage.AdminFilesModel
@{
    ViewData["Title"] = "Admin Files";
    Layout = "_LayoutDashboard";
}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-table@1.24.1/dist/bootstrap-table.min.css">

<style>
    .select, #locale {
        width: 100%;
    }

    .like {
        margin-right: 10px;
    }

    .fixed-table-container thead th {
        background-color: #f0f0f0;
    }

    .table-bordered td, .table-bordered th {
        border: 1px solid #dee2e6;
    }

    .pagination {
        justify-content: flex-end;
    }

    .search input {
        border: 1px solid #28a745;
    }

    .share-btn {
        color: #28a745;
    }

    .edit-btn {
        color: #007bff;
    }

    .delete-btn {
        color: #dc3545;
    }

    .full-height {
        height: 100vh;
        display: flex;
        flex-direction: column;
    }

    .table-container {
        flex: 1;
        overflow: auto;
    }

    #previewSection {
        border: 1px solid #ccc;
        padding: 10px;
        height: 300px;
        overflow-y: auto;
    }

    #uploadFile {
        margin-bottom: 10px;
    }

    #previewContainer p {
        text-align: center;
        font-style: italic;
        color: #666;
    }
</style>

<div class="container-fluid full-height">
    <h2 class="text-center">Document List</h2>
    <div class="row table-container">
        <div class="col-md-12">
            <div id="toolbar">
                <button id="remove" class="btn btn-danger" disabled>
                    <i class="fa fa-trash"></i> Delete
                </button>
            </div>
            <table id="table"
                   data-toolbar="#toolbar"
                   data-search="true"
                   data-show-refresh="true"
                   data-show-toggle="true"
                   data-show-fullscreen="true"
                   data-show-columns="true"
                   data-show-columns-toggle-all="true"
                   data-detail-view="true"
                   data-show-export="true"
                   data-click-to-select="true"
                   data-minimum-count-columns="2"
                   data-show-pagination-switch="true"
                   data-pagination="true"
                   data-id-field="id"
                   data-page-list="[10, 25, 50, 100, all]"
                   data-side-pagination="server"
                   data-url="https://examples.wenzhixin.net.cn/examples/bootstrap_table/data"
                   data-response-handler="responseHandler">
            </table>
        </div>
    </div>
</div>

<!-- Share Modal -->
<div class="modal fade" id="shareModal" tabindex="-1" aria-labelledby="shareModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="shareModalLabel">Share Document</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form>
                    <div class="mb-3">
                        <label for="shareEmail" class="form-label">Recipient Email</label>
                        <input type="email" class="form-control" id="shareEmail" placeholder="Enter recipient email">
                    </div>
                    <div class="mb-3">
                        <label for="shareMessage" class="form-label">Message (Optional)</label>
                        <textarea class="form-control" id="shareMessage" rows="3" placeholder="Add a message..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success">Share</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Modal -->
<div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editModalLabel">Edit Document</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editForm">
                    <div class="mb-3">
                        <label for="editName" class="form-label">Name</label>
                        <input type="text" class="form-control" id="editName" placeholder="Enter document name">
                    </div>
                    <div class="mb-3">
                        <label for="editCategories" class="form-label">Categories</label>
                        <input type="text" class="form-control" id="editCategories" placeholder="Enter categories">
                    </div>
                    <div class="mb-3">
                        <label for="editContentType" class="form-label">Content Type</label>
                        <input type="text" class="form-control" id="editContentType" placeholder="Enter content type">
                    </div>
                    <div class="mb-3">
                        <label for="uploadFile" class="form-label">Upload Document/PNG / PDF / DOC Files</label>
                        <input type="file" class="form-control" id="uploadFile" accept=".doc,.docx,.pdf,.png">
                    </div>
                    <!-- Preview Section -->
                    <div id="previewSection" class="mt-3">
                        <h5>Preview:</h5>
                        <div id="previewContainer" style="border: 1px solid #ccc; padding: 10px; height: 300px; overflow-y: auto;">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveChangesBtn">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<!-- View Modal -->
<div class="modal fade" id="viewModal" tabindex="-1" aria-labelledby="viewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewModalLabel">View Document</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <dl class="row">
                    <dt class="col-sm-3">Name:</dt>
                    <dd class="col-sm-9" id="view-name"></dd>
                    <dt class="col-sm-3">Categories:</dt>
                    <dd class="col-sm-9" id="view-categories"></dd>
                    <dt class="col-sm-3">Content Type:</dt>
                    <dd class="col-sm-9" id="view-content_type"></dd>
                    <dt class="col-sm-3">Size (KB):</dt>
                    <dd class="col-sm-9" id="view-size_kb"></dd>
                    <dt class="col-sm-3">Assign:</dt>
                    <dd class="col-sm-9" id="view-assign"></dd>
                    <dt class="col-sm-3">Status:</dt>
                    <dd class="col-sm-9" id="view-status"></dd>
                    <dt class="col-sm-3">Created Date:</dt>
                    <dd class="col-sm-9" id="view-created_date"></dd>
                </dl>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap-table@1.24.1/dist/bootstrap-table.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap-table@1.24.1/dist/extensions/locale/bootstrap-table-locale-all.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tableexport.jquery.plugin@1.29.0/tableExport.min.js"></script>

<script>
    const $table = $('#table');
    const $remove = $('#remove');
    let selections = [];

    // Function to get selected IDs
    function getIdSelections() {
        return $.map($table.bootstrapTable('getSelections'), function (row) {
            return row.id;
        });
    }

    // Response handler for server-side data
    window.responseHandler = res => {
        $.each(res.rows, function (i, row) {
            row.state = $.inArray(row.id, selections) !== -1;
        });
        return res;
    };

    window.detailFormatter = (index, row) => {
        const html = [];
        $.each(row, function (key, value) {
            html.push(`<p><b>${key}:</b> ${value}</p>`);
        });
        return html.join('');
    };

    function operateFormatter(value, row, index) {
        return [
            '<a class="share-btn" href="javascript:void(0)" title="Share">',
            '<i class="fa fa-share-alt"></i>',
            '</a> ',
            '<a class="edit-btn" href="javascript:void(0)" title="Edit">',
            '<i class="fa fa-edit"></i>',
            '</a> ',
            '<a class="view-btn" href="javascript:void(0)" title="View">',
            '<i class="fa fa-eye"></i>',
            '</a> ',
            '<a class="delete-btn" href="javascript:void(0)" title="Delete">',
            '<i class="fa fa-trash"></i>',
            '</a>'
        ].join('');
    }

    window.operateEvents = {
        'click .share-btn': function (e, value, row) {
            $('#shareModal').modal('show');
        },
        'click .edit-btn': function (e, value, row) {
            $('#editName').val(row.name);
            $('#editCategories').val(row.categories);
            $('#editContentType').val(row.content_type);
            $('#editModal').modal('show');
        },
        'click .view-btn': function (e, value, row) {
            $('#view-name').text(row.name || '-');
            $('#view-categories').text(row.categories || '-');
            $('#view-content_type').text(row.content_type || '-');
            $('#view-size_kb').text(row.size_kb || '-');
            $('#view-assign').text(row.assign || '-');
            $('#view-status').text(row.status || '-');
            $('#view-created_date').text(row.created_date || '-');

            $('#viewModal').modal('show');
        },
        'click .delete-btn': function (e, value, row) {
            $table.bootstrapTable('remove', {
                field: 'id',
                values: [row.id]
            });
        }
    };

    function initTable() {
        $table.bootstrapTable('destroy').bootstrapTable({
            height: $(window).height() - $('h2').outerHeight(true) - $('#toolbar').outerHeight(true) - 30,
            locale: $('#locale').val(),
            columns: [
                [
                    {
                        field: 'state',
                        checkbox: true,
                        align: 'center',
                        valign: 'middle'
                    },
                    {
                        field: 'id',
                        title: 'ID',
                        sortable: true,
                        align: 'center'
                    },
                    {
                        field: 'name',
                        title: 'Name',
                        sortable: true,
                        align: 'left'
                    },
                    {
                        field: 'categories',
                        title: 'Categories',
                        sortable: true,
                        align: 'left'
                    },
                    {
                        field: 'content_type',
                        title: 'Content Type',
                        sortable: true,
                        align: 'left'
                    },
                    {
                        field: 'size_kb',
                        title: 'Size(KB)',
                        sortable: true,
                        align: 'right'
                    },
                    {
                        field: 'assign',
                        title: 'Assign',
                        sortable: true,
                        align: 'left'
                    },
                    {
                        field: 'status',
                        title: 'Status',
                        sortable: true,
                        align: 'left'
                    },
                    {
                        field: 'created_date',
                        title: 'Created Date',
                        sortable: true,
                        align: 'left'
                    },
                    {
                        field: 'operate',
                        title: 'Action',
                        events: window.operateEvents,
                        formatter: operateFormatter,
                        align: 'center'
                    }
                ]
            ]
        });

        $table.on('check.bs.table uncheck.bs.table check-all.bs.table uncheck-all.bs.table', function () {
            $remove.prop('disabled', !$table.bootstrapTable('getSelections').length);
            selections = getIdSelections();
        });

        $remove.click(function () {
            const ids = getIdSelections();
            $table.bootstrapTable('remove', {
                field: 'id',
                values: ids
            });
            $remove.prop('disabled', true);
        });

        document.getElementById('uploadFile').addEventListener('change', function () {
            const file = this.files[0];
            if (!file) return;

            const allowedTypes = ['application/pdf', 'image/png', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'];
            if (!allowedTypes.includes(file.type)) {
                alert('Invalid file type. Only .doc, .docx, .pdf, and .png files are allowed.');
                return;
            }

            document.getElementById('previewContainer').innerHTML = '';

            if (file.type === 'application/pdf') {
                const pdfViewer = document.createElement('iframe');
                pdfViewer.src = URL.createObjectURL(file);
                pdfViewer.style.width = '100%';
                pdfViewer.style.height = '100%';
                document.getElementById('previewContainer').appendChild(pdfViewer);
            } else if (file.type.startsWith('image/')) {
                const imgPreview = document.createElement('img');
                imgPreview.src = URL.createObjectURL(file);
                imgPreview.style.maxWidth = '100%';
                imgPreview.style.maxHeight = '100%';
                document.getElementById('previewContainer').appendChild(imgPreview);
            } else if (file.type.startsWith('application/')) {
                const wordPlaceholder = document.createElement('p');
                wordPlaceholder.textContent = 'Word document preview is not available. Please download to view.';
                document.getElementById('previewContainer').appendChild(wordPlaceholder);
            }
        });

        document.getElementById('saveChangesBtn').addEventListener('click', function () {
            const name = document.getElementById('editName').value;
            const categories = document.getElementById('editCategories').value;
            const contentType = document.getElementById('editContentType').value;
            const fileInput = document.getElementById('uploadFile');

            if (!name || !categories || !contentType || !fileInput.files[0]) {
                alert('Please fill out all fields and upload a file.');
                return;
            }

            // Simulate saving changes (replace with actual API call)
            console.log('Saving changes...');
            console.log({
                name,
                categories,
                contentType,
                file: fileInput.files[0].name
            });

            $('#editModal').modal('hide');
        });
    }

    $(function () {
        initTable();

        $('#locale').change(initTable);
    });
</script>