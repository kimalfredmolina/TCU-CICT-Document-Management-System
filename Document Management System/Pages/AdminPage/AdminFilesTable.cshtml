@page
@model Document_Management_System.Pages.AdminPage.AdminFilesModel
@{
    ViewData["Title"] = "Admin Files";
    Layout = "_LayoutDashboard";
}

<!-- Bootstrap CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
<!-- Font Awesome Icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<!-- Bootstrap Table CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-table@1.24.1/dist/bootstrap-table.min.css">

<style>
    /* Your original styles plus enhancements */
    .search-container {
        margin-bottom: 1px;
        display: flex;
        gap: 10px;
        max-width: 500px;
        max-height: 45px;
    }
    /* Keep your original table styling */
    #documentTable {
        width: 100%;
        margin-top: 20px;
    }
    /* Action buttons styling */
    .action-btn {
        margin: 0 5px;
        cursor: pointer;
    }
    /* Bootstrap Table overrides */
    .fixed-table-toolbar .search-input {
        display: none; /* Hide the Bootstrap Table search box */
    }

    /* Preview Section */
    #previewSection {
        border: 1px solid #ccc;
        padding: 10px;
        height: 300px;
        overflow-y: auto;
    }

    #previewContainer {
        border: 1px solid #ccc;
        padding: 10px;
        height: 100%;
        overflow-y: auto;
    }

    /* Modal Styles */
    .modal-header {
        background-color: #f8f9fa;
    }

    .btn-sm {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
    }
</style>

<div class="container-fluid">
    <h2>Document List</h2>

    <!-- Search and Delete Toolbar -->
    <div class="d-flex justify-content-between mb-3">
        <div class="search-container">
            <form method="get" class="d-flex">
                <input type="text" name="SearchQuery" value="@Model.SearchQuery"
                       placeholder="Search documents..." class="form-control me-2" />
                <button type="submit" class="btn btn-primary">Search</button>
            </form>
        </div>
    </div>

    <!-- Enhanced table with Bootstrap Table -->
    <table id="documentTable"
           data-toggle="table"
           data-pagination="true"
           data-page-size="10"
           data-search="false">
        <thead>
            <tr>
                <th data-field="id" data-sortable="true">ID</th>
                <th data-field="filename" data-sortable="true">File Name</th>
                <th data-field="category" data-sortable="true">Category</th>
                <th data-field="contentType" data-sortable="true">Content Type</th>
                <th data-field="filesize" data-sortable="true">File Size</th>
                <th data-field="fileType" data-sortable="true">File Type</th>
                <th data-field="uploadedBy" data-sortable="true">Uploaded By</th>
                <th data-field="uploadedDate" data-sortable="true">Uploaded Date</th>
                <th data-field="actions">Actions</th>
            </tr>
        </thead>
        <tbody>
            @if (Model.Documents != null && Model.Documents.Any())
            {
                foreach (var document in Model.Documents)
                {
                    <tr>
                        <td>@document.Id</td>
                        <td>@document.Filename</td>
                        <td>@(document.CategoryId.HasValue ? document.CategoryId.Value.ToString() : "N/A")</td>
                        <td>@(document.ContentType ?? "N/A")</td>
                        <td>@(document.Filesize.HasValue ? document.Filesize.Value.ToString() : "N/A")</td>
                        <td>@document.FileType</td>
                        <td>@document.UploadedBy</td>
                        <td>@(document.UploadedDate.HasValue ? document.UploadedDate.Value.ToString("yyyy-MM-dd HH:mm:ss") : "N/A")</td>
                        <td>
                            <button class="btn btn-primary btn-sm edit-btn" data-id="@document.Id">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="btn btn-danger btn-sm delete-btn" data-id="@document.Id">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </td>
                    </tr>
                }
            }
            else
            {
                <tr>
                    <td colspan="9">No documents found.</td>
                </tr>
            }
        </tbody>
    </table>
</div>

<!-- Edit Modal -->
<div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editModalLabel">Edit Document</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editForm">
                    <div class="mb-3">
                        <label for="editName" class="form-label">File Name</label>
                        <input type="text" class="form-control" id="editName" placeholder="Enter document name">
                    </div>
                    <div class="mb-3">
                        <label for="editCategories" class="form-label">Categories</label>
                        <input type="text" class="form-control" id="editCategories" placeholder="Enter categories">
                    </div>
                    <div class="mb-3">
                        <label for="editContentType" class="form-label">Content Type</label>
                        <input type="text" class="form-control" id="editContentType" placeholder="Enter content type">
                    </div>
                    <div class="mb-3">
                        <label for="uploadFile" class="form-label">Upload Document/PNG / PDF / DOC Files</label>
                        <input type="file" class="form-control" id="uploadFile" accept=".doc,.docx,.pdf,.png">
                    </div>
                    <!-- Preview Section -->
                    <div id="previewSection" class="mt-3">
                        <h5>Preview:</h5>
                        <div id="previewContainer">
                            <p class="text-muted">Preview will appear here after file selection</p>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveChangesBtn">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap-table@1.24.1/dist/bootstrap-table.min.js"></script>

<script>
    $(function() {
        // Initialize Bootstrap Table with sorting and pagination
        $('#documentTable').bootstrapTable({
            search: false, // Disable the built-in search
            sortable: true,
            pagination: true,
            pageSize: 10
        });

        // Edit button handler
        $(document).on('click', '.edit-btn', function() {
            const documentId = $(this).data('id');
            const row = $(this).closest('tr');

            // Populate modal with document data
            $('#editName').val(row.find('td:eq(1)').text());
            $('#editCategories').val(row.find('td:eq(2)').text());
            $('#editContentType').val(row.find('td:eq(3)').text());

            // Show modal
            $('#editModal').modal('show');
        });

        // Delete button handler
        $(document).on('click', '.delete-btn', function() {
            const documentId = $(this).data('id');
            if (confirm(`Are you sure you want to delete document with ID: ${documentId}?`)) {
                // Perform delete operation here
                console.log(`Deleting document with ID: ${documentId}`);
            }
        });

        // File upload preview handler
        $('#uploadFile').on('change', function() {
            const file = this.files[0];
            const previewContainer = $('#previewContainer');
            previewContainer.empty();

            if (!file) return;

            // Validate file type
            const allowedTypes = ['application/pdf', 'image/png', 'application/msword',
                                 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'];
            if (!allowedTypes.includes(file.type)) {
                alert('Invalid file type. Only .doc, .docx, .pdf, and .png files are allowed.');
                $(this).val('');
                return;
            }

            if (file.type === 'application/pdf') {
                const pdfViewer = $('<iframe>').attr('src', URL.createObjectURL(file))
                    .css({'width': '100%', 'height': '100%'});
                previewContainer.append(pdfViewer);
            } else if (file.type.startsWith('image/')) {
                const imgPreview = $('<img>').attr('src', URL.createObjectURL(file))
                    .css({'max-width': '100%', 'max-height': '100%'});
                previewContainer.append(imgPreview);
            } else {
                previewContainer.append('<p>Word document preview is not available. Please download to view.</p>');
            }
        });

        // Save changes handler
        $('#saveChangesBtn').on('click', function() {
            const name = $('#editName').val();
            const categories = $('#editCategories').val();
            const contentType = $('#editContentType').val();
            const fileInput = $('#uploadFile')[0];

            if (!name || !categories || !contentType) {
                alert('Please fill out all required fields.');
                return;
            }

            // Prepare data for saving
            const updatedData = {
                id: $('.edit-btn').data('id'),
                name,
                categories,
                contentType,
                file: fileInput.files[0] ? fileInput.files[0].name : null
            };

            console.log('Saving changes:', updatedData);
            // Here you would typically make an AJAX call to save the changes

            $('#editModal').modal('hide');
        });
    });
</script>